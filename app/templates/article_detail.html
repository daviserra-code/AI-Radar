{% extends "base.html" %}
{% block content %}

<article class="article-detail">
  <header class="article-header">
    <div class="badge-row">
      <span class="pill pill-category">
        {% if article.category %}
          {{ article.category.icon or 'ğŸ“' }} {{ article.category.name }}
        {% else %}
          ğŸ“ Generale
        {% endif %}
      </span>
      {% if article.ai_generated %}
        <span class="pill pill-ai">AI generated</span>
      {% else %}
        <span class="pill pill-editorial">Editoriale</span>
      {% endif %}
    </div>

    <h1 class="article-title">{{ article.title }}</h1>

    {% if article.title_en %}
    <div style="margin: 1rem 0;">
      <button id="langToggle" onclick="toggleLanguage()" style="padding: 0.5rem 1rem; background: var(--bg-card); color: var(--neon-cyan); border: 1px solid var(--neon-cyan); border-radius: 4px; cursor: pointer; font-weight: 600;">
        ğŸŒ Show in English
      </button>
    </div>
    {% endif %}

    <div class="meta meta-article">
      <span class="date">Pubblicato il {{ article.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
      {% if article.source_name and article.credibility_score %}
        {% set badge = get_credibility_badge(article.credibility_score) %}
        <span class="credibility-badge {{ badge.class }}" 
              style="background: {{ badge.color }}20; border: 1px solid {{ badge.color }}; color: {{ badge.color }}; 
                     padding: 0.4rem 0.8rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600;" 
              title="{{ badge.label }}">
          {{ badge.badge }} {{ article.source_name }}
        </span>
      {% endif %}
      {% if article.source_url %}
      <span class="source-link">
        <a href="{{ article.source_url }}" target="_blank" style="color: var(--neon-cyan); font-weight: 600;">ğŸ“° Leggi l'articolo originale â†’</a>
      </span>
      {% endif %}
    </div>
    
    {% if article.tags %}
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
      {% for tag in article.tags %}
        <a href="/tag/{{ tag.slug }}" 
           style="display: inline-block; padding: 0.4rem 0.8rem; background: var(--bg-card); 
                  color: var(--neon-cyan); border: 1px solid var(--neon-cyan); border-radius: 15px; 
                  text-decoration: none; font-size: 0.85em; font-weight: 600; transition: all 0.2s;"
           onmouseover="this.style.background='rgba(0,255,255,0.2)';"
           onmouseout="this.style.background='var(--bg-card)';">
          ğŸ·ï¸ {{ tag.name }}
        </a>
      {% endfor %}
    </div>
    {% endif %}
  </header>

  {% if article.image_url %}
  <div style="margin: 2rem 0; text-align: center;">
    <img src="{{ article.image_url }}" alt="{{ article.title }}" loading="lazy"
         style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--border-dim); image-rendering: -webkit-optimize-contrast; image-rendering: smooth;">
  </div>
  {% endif %}

  <section class="article-body" id="articleContent">
    <div id="contentIt" style="display: block;">
      {{ article.content | safe }}
    </div>
    {% if article.content_en %}
    <div id="contentEn" style="display: none;">
      {{ article.content_en | safe }}
    </div>
    {% endif %}
  </section>

  {% if article.source_url %}
  <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border-dim); border-radius: 8px; text-align: center;">
    <p style="margin-bottom: 1rem; color: var(--text-muted);">Vuoi approfondire? Leggi l'articolo completo dalla fonte:</p>
    <a href="{{ article.source_url }}" target="_blank" rel="noopener" 
       style="display: inline-block; padding: 0.75rem 2rem; background: var(--neon-cyan); color: #000; border-radius: 4px; font-weight: 600; text-decoration: none;">
      ğŸ“– VAI ALLA FONTE ORIGINALE
    </a>
  </div>
  {% endif %}

  {% if article.editor_comment %}
  <aside class="editor-comment">
    <h2>Commento editoriale</h2>
    <p>{{ article.editor_comment }}</p>
    <p class="editor-sign">â€” Davide</p>
  </aside>
  {% else %}
  <aside class="editor-comment editor-comment-empty">
    <h2>Spazio editoriale</h2>
    <p>Qui potrai aggiungere, quando vuoi, il tuo take ironico/tecnico su questo contenuto AI-generated.</p>
  </aside>
  {% endif %}

  <!-- COMMENTS SECTION -->
  <section class="comments-section" style="margin-top: 3rem;">
    <h2 style="margin-bottom: 1.5rem; font-size: 1.3rem;">ğŸ’¬ Commenti ({{ comments|length }})</h2>
    
    {% if current_user and current_user.is_subscribed %}
      <!-- Comment Form for Subscribed Users -->
      <div class="comment-form" style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border-dim); border-radius: 8px;">
        <form method="post" action="/article/{{ article.slug }}/comment">
          <textarea name="content" rows="4" placeholder="Aggiungi il tuo commento..." required 
                    style="width: 100%; padding: 0.75rem; background: var(--bg-deep); border: 1px solid var(--border-dim); border-radius: 4px; color: var(--text-main); font-family: inherit; resize: vertical;"></textarea>
          <button type="submit" style="margin-top: 0.75rem; padding: 0.5rem 1.5rem; background: var(--neon-cyan); color: #000; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">
            Pubblica Commento
          </button>
        </form>
      </div>
    {% elif current_user %}
      <div style="padding: 1rem; background: var(--bg-card); border: 1px solid var(--border-dim); border-radius: 8px; margin-bottom: 2rem;">
        <p style="color: var(--text-muted);">ğŸ”’ Solo gli utenti con subscription possono commentare. <a href="/subscribe" style="color: var(--neon-cyan);">Attiva la tua subscription</a></p>
      </div>
    {% else %}
      <div style="padding: 1rem; background: var(--bg-card); border: 1px solid var(--border-dim); border-radius: 8px; margin-bottom: 2rem;">
        <p style="color: var(--text-muted);">ğŸ”’ <a href="/login" style="color: var(--neon-cyan);">Accedi</a> o <a href="/register" style="color: var(--neon-cyan);">registrati</a> per commentare gli articoli.</p>
      </div>
    {% endif %}

    <!-- Display Comments -->
    <div class="comments-list">
      {% for comment in comments %}
      <div class="comment-item" style="padding: 1.25rem; background: var(--bg-card); border: 1px solid var(--border-dim); border-radius: 8px; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <div>
            <span style="color: var(--neon-cyan); font-weight: 600;">@{{ comment.user.username }}</span>
            {% if comment.user.is_subscribed %}
            <span style="color: var(--neon-green); font-size: 0.75rem; margin-left: 0.5rem;">âœ“ Subscriber</span>
            {% endif %}
          </div>
          <span style="color: var(--text-muted); font-size: 0.85rem;">{{ comment.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
        </div>
        <p style="color: var(--text-main); line-height: 1.6;">{{ comment.content }}</p>
        {% if current_user and current_user.id == comment.user_id %}
        <form method="post" action="/comment/{{ comment.id }}/delete" style="margin-top: 0.75rem;">
          <button type="submit" style="padding: 0.25rem 0.75rem; background: transparent; color: var(--text-muted); border: 1px solid var(--border-dim); border-radius: 4px; font-size: 0.85rem; cursor: pointer;">
            Elimina
          </button>
        </form>
        {% endif %}
      </div>
      {% endfor %}
      
      {% if not comments %}
      <p style="color: var(--text-muted); text-align: center; padding: 2rem;">Nessun commento ancora. Sii il primo a commentare!</p>
      {% endif %}
    </div>
  </section>
</article>

{% if article.content_en %}
<script>
let currentLang = 'it';

function toggleLanguage() {
  const contentIt = document.getElementById('contentIt');
  const contentEn = document.getElementById('contentEn');
  const button = document.getElementById('langToggle');
  
  if (currentLang === 'it') {
    contentIt.style.display = 'none';
    contentEn.style.display = 'block';
    button.textContent = 'ğŸ‡®ğŸ‡¹ Mostra in Italiano';
    currentLang = 'en';
  } else {
    contentIt.style.display = 'block';
    contentEn.style.display = 'none';
    button.textContent = 'ğŸŒ Show in English';
    currentLang = 'it';
  }
}
</script>
{% endif %}

<!-- RELATED ARTICLES -->
{% if related_articles %}
<div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-dim);">
  <h2 style="font-size: 1.3rem; margin-bottom: 1.5rem; color: var(--neon-cyan);">
    ğŸ“š Articoli Correlati
  </h2>
  <div class="news-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
    {% for related in related_articles %}
    <div class="card">
      <span class="card-tag">{{ related.category.name }}</span>
      <h3><a href="/article/{{ related.slug }}">{{ related.title }}</a></h3>
      <p>{{ related.summary[:120] }}...</p>
      <div class="card-meta">
        <span>{{ related.created_at.strftime('%d/%m/%Y') }}</span>
        <a href="/article/{{ related.slug }}">Leggi â†’</a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% endblock %}
