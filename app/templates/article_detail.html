{% extends "base.html" %}
{% block content %}

<article class="article-detail">
  <header class="article-header">
    <div class="badge-row">
      <span class="pill pill-category">
        {% if article.category %}
          {{ article.category.name }}
        {% else %}
          Generale
        {% endif %}
      </span>
      {% if article.ai_generated %}
        <span class="pill pill-ai">AI generated</span>
      {% else %}
        <span class="pill pill-editorial">Editoriale</span>
      {% endif %}
    </div>

    <h1 class="article-title">{{ article.title }}</h1>

    <div class="meta meta-article">
      <span class="date">Pubblicato il {{ article.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
      {% if article.source_url %}
      <span class="source-link">
        <a href="{{ article.source_url }}" target="_blank" style="color: var(--neon-cyan); font-weight: 600;">ðŸ“° Leggi l'articolo originale â†’</a>
      </span>
      {% endif %}
    </div>
  </header>

  {% if article.image_url %}
  <div style="margin: 2rem 0; text-align: center;">
    <img src="{{ article.image_url }}" alt="{{ article.title }}" 
         style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--border-dim);">
  </div>
  {% endif %}

  <section class="article-body">
    {{ article.content | safe }}
  </section>

  {% if article.source_url %}
  <div style="margin: 2rem 0; padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border-dim); border-radius: 8px; text-align: center;">
    <p style="margin-bottom: 1rem; color: var(--text-muted);">Vuoi approfondire? Leggi l'articolo completo dalla fonte:</p>
    <a href="{{ article.source_url }}" target="_blank" rel="noopener" 
       style="display: inline-block; padding: 0.75rem 2rem; background: var(--neon-cyan); color: #000; border-radius: 4px; font-weight: 600; text-decoration: none;">
      ðŸ“– VAI ALLA FONTE ORIGINALE
    </a>
  </div>
  {% endif %}

  {% if article.editor_comment %}
  <aside class="editor-comment">
    <h2>Commento editoriale</h2>
    <p>{{ article.editor_comment }}</p>
    <p class="editor-sign">â€” Davide</p>
  </aside>
  {% else %}
  <aside class="editor-comment editor-comment-empty">
    <h2>Spazio editoriale</h2>
    <p>Qui potrai aggiungere, quando vuoi, il tuo take ironico/tecnico su questo contenuto AI-generated.</p>
  </aside>
  {% endif %}

  <!-- COMMENTS SECTION -->
  <section class="comments-section" style="margin-top: 3rem;">
    <h2 style="margin-bottom: 1.5rem; font-size: 1.3rem;">ðŸ’¬ Commenti ({{ comments|length }})</h2>
    
    {% if current_user and current_user.is_subscribed %}
      <!-- Comment Form for Subscribed Users -->
      <div class="comment-form" style="margin-bottom: 2rem; padding: 1.5rem; background: var(--bg-card); border: 1px solid var(--border-dim); border-radius: 8px;">
        <form method="post" action="/article/{{ article.slug }}/comment">
          <textarea name="content" rows="4" placeholder="Aggiungi il tuo commento..." required 
                    style="width: 100%; padding: 0.75rem; background: var(--bg-deep); border: 1px solid var(--border-dim); border-radius: 4px; color: var(--text-main); font-family: inherit; resize: vertical;"></textarea>
          <button type="submit" style="margin-top: 0.75rem; padding: 0.5rem 1.5rem; background: var(--neon-cyan); color: #000; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">
            Pubblica Commento
          </button>
        </form>
      </div>
    {% elif current_user %}
      <div style="padding: 1rem; background: var(--bg-card); border: 1px solid var(--border-dim); border-radius: 8px; margin-bottom: 2rem;">
        <p style="color: var(--text-muted);">ðŸ”’ Solo gli utenti con subscription possono commentare. <a href="/subscribe" style="color: var(--neon-cyan);">Attiva la tua subscription</a></p>
      </div>
    {% else %}
      <div style="padding: 1rem; background: var(--bg-card); border: 1px solid var(--border-dim); border-radius: 8px; margin-bottom: 2rem;">
        <p style="color: var(--text-muted);">ðŸ”’ <a href="/login" style="color: var(--neon-cyan);">Accedi</a> o <a href="/register" style="color: var(--neon-cyan);">registrati</a> per commentare gli articoli.</p>
      </div>
    {% endif %}

    <!-- Display Comments -->
    <div class="comments-list">
      {% for comment in comments %}
      <div class="comment-item" style="padding: 1.25rem; background: var(--bg-card); border: 1px solid var(--border-dim); border-radius: 8px; margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <div>
            <span style="color: var(--neon-cyan); font-weight: 600;">@{{ comment.user.username }}</span>
            {% if comment.user.is_subscribed %}
            <span style="color: var(--neon-green); font-size: 0.75rem; margin-left: 0.5rem;">âœ“ Subscriber</span>
            {% endif %}
          </div>
          <span style="color: var(--text-muted); font-size: 0.85rem;">{{ comment.created_at.strftime("%Y-%m-%d %H:%M") }}</span>
        </div>
        <p style="color: var(--text-main); line-height: 1.6;">{{ comment.content }}</p>
        {% if current_user and current_user.id == comment.user_id %}
        <form method="post" action="/comment/{{ comment.id }}/delete" style="margin-top: 0.75rem;">
          <button type="submit" style="padding: 0.25rem 0.75rem; background: transparent; color: var(--text-muted); border: 1px solid var(--border-dim); border-radius: 4px; font-size: 0.85rem; cursor: pointer;">
            Elimina
          </button>
        </form>
        {% endif %}
      </div>
      {% endfor %}
      
      {% if not comments %}
      <p style="color: var(--text-muted); text-align: center; padding: 2rem;">Nessun commento ancora. Sii il primo a commentare!</p>
      {% endif %}
    </div>
  </section>
</article>

{% endblock %}
